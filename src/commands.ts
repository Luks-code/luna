import { Command, COMMANDS, ComplaintStatus, ConversationState, ConversationMode } from './types';
import { setConversationState, initialConversationState, addMessageToHistory, redis, deleteConversation } from './redis';
import { sendWhatsAppMessage } from './whatsapp';
import { prisma } from './prisma';

export async function handleCommand(from: string, command: string, state: ConversationState): Promise<void> {
  const parts = command.toUpperCase().split(' ');
  const cmd = parts[0] as Command;
  const args = parts.slice(1);

  switch (cmd) {
    case COMMANDS.CANCELAR:
      await handleCancel(from, state);
      break;
    case COMMANDS.AYUDA:
      await handleHelp(from);
      break;
    case COMMANDS.ESTADO:
      await handleStatus(from, state);
      break;
    case COMMANDS.REINICIAR:
      await handleReset(from);
      break;
    case COMMANDS.CONFIRMAR:
      await handleConfirm(from, state);
      break;
    case COMMANDS.MISRECLAMOS:
      await handleMyComplaints(from);
      break;
    case COMMANDS.RECLAMO:
      if (args.length === 0) {
        // Si no hay argumentos, cambiar al modo de reclamos
        await handleModeChange(from, state, ConversationMode.COMPLAINT);
      } else {
        // Si hay argumentos, buscar detalles del reclamo espec√≠fico
        await handleComplaintDetails(from, parseInt(args[0]));
      }
      break;
    case COMMANDS.INFO:
    case COMMANDS.CONSULTA:
      await handleModeChange(from, state, ConversationMode.INFO);
      break;
    case COMMANDS.NORMAL:
    case COMMANDS.DEFAULT:
      await handleModeChange(from, state, ConversationMode.DEFAULT);
      break;
    default:
      const message = 'Comando no reconocido. Usa /ayuda para ver los comandos disponibles.';
      await sendWhatsAppMessage(from, message);
      await addMessageToHistory(from, 'assistant', message);
  }
}

async function handleCancel(from: string, state: ConversationState): Promise<void> {
  let message = '';
  
  if (!state.isComplaintInProgress) {
    message = 'No hay ninguna operaci√≥n en curso para cancelar.';
    await sendWhatsAppMessage(from, message);
    await addMessageToHistory(from, 'assistant', message);
  } else {
    // Mensaje de cancelaci√≥n
    message = 'Se ha cancelado el reclamo en curso.';
    await sendWhatsAppMessage(from, message);
    await addMessageToHistory(from, 'assistant', message);
    
    // Mensaje de reinicio
    const resetMessage = 'La conversaci√≥n ha sido reiniciada completamente.';
    await sendWhatsAppMessage(from, resetMessage);
    
    // Eliminar completamente la conversaci√≥n usando la nueva funci√≥n
    const deleted = await deleteConversation(from);
    console.log(`[Comando /cancelar] Conversaci√≥n eliminada: ${deleted ? 'S√≠' : 'No'}`);
  }
}

async function handleHelp(from: string): Promise<void> {
  const helpMessage = `Comandos disponibles:
/ayuda - Muestra este mensaje
/estado - Muestra el estado actual del reclamo en curso
/cancelar - Cancela el reclamo en curso
/reiniciar - Reinicia la conversaci√≥n
/confirmar - Confirma el reclamo cuando se solicite
/misreclamos - Muestra todos tus reclamos
/reclamo - Cambia al modo de reclamos para iniciar un nuevo reclamo
/reclamo <n√∫mero> - Muestra los detalles de un reclamo espec√≠fico
/info o /consulta - Cambia al modo de informaci√≥n para hacer consultas
/normal o /default - Vuelve al modo normal de conversaci√≥n

Para iniciar un reclamo, puedes usar el comando /reclamo o simplemente describir tu problema y te guiar√© en el proceso.`;

  await sendWhatsAppMessage(from, helpMessage);
  await addMessageToHistory(from, 'assistant', helpMessage);
}

async function handleStatus(from: string, state: ConversationState): Promise<void> {
  let message = '';
  
  if (!state.isComplaintInProgress) {
    message = 'No hay ning√∫n reclamo en curso.';
  } else {
    const { complaintData } = state;
    message = `Estado actual del reclamo:
${complaintData.type ? `‚úÖ Tipo: ${complaintData.type}` : '‚ùå Tipo: Pendiente'}
${complaintData.description ? `‚úÖ Descripci√≥n: ${complaintData.description}` : '‚ùå Descripci√≥n: Pendiente'}
${complaintData.location ? `‚úÖ Ubicaci√≥n: ${complaintData.location}` : '‚ùå Ubicaci√≥n: Pendiente'}
${complaintData.citizenData?.name ? `‚úÖ Nombre: ${complaintData.citizenData.name}` : '‚ùå Nombre: Pendiente'}
${complaintData.citizenData?.documentId ? `‚úÖ DNI: ${complaintData.citizenData.documentId}` : '‚ùå DNI: Pendiente'}
${complaintData.citizenData?.address ? `‚úÖ Direcci√≥n: ${complaintData.citizenData.address}` : '‚ùå Direcci√≥n: Pendiente'}`;
  }

  await sendWhatsAppMessage(from, message);
  await addMessageToHistory(from, 'assistant', message);
}

async function handleReset(from: string): Promise<void> {
  const message = 'La conversaci√≥n ha sido reiniciada completamente. ¬øEn qu√© puedo ayudarte?';
  
  // Eliminar completamente la conversaci√≥n de Redis usando la nueva funci√≥n
  const deleted = await deleteConversation(from);
  console.log(`[Comando /reiniciar] Conversaci√≥n eliminada: ${deleted ? 'S√≠' : 'No'}`);
  
  // Enviar mensaje de confirmaci√≥n
  await sendWhatsAppMessage(from, message);
}

async function handleConfirm(from: string, state: ConversationState): Promise<void> {
  let message = '';
  
  if (!state.awaitingConfirmation) {
    message = 'No hay ning√∫n reclamo pendiente de confirmaci√≥n.';
  } else {
    // La confirmaci√≥n real se maneja en whatsapp.ts
    state.confirmedData = state.complaintData;
    await setConversationState(from, state);
    message = 'Procesando confirmaci√≥n...';
  }
  
  await sendWhatsAppMessage(from, message);
  await addMessageToHistory(from, 'assistant', message);
}

function getStatusEmoji(status: ComplaintStatus): string {
  switch (status) {
    case ComplaintStatus.PENDIENTE:
      return '‚è≥';
    case ComplaintStatus.EN_PROCESO:
      return 'üîÑ';
    case ComplaintStatus.RESUELTO:
      return '‚úÖ';
    case ComplaintStatus.CANCELADO:
      return '‚ùå';
    default:
      return '‚ùì';
  }
}

async function handleMyComplaints(from: string): Promise<void> {
  try {
    // Buscar el ciudadano por n√∫mero de tel√©fono
    const citizen = await prisma.citizen.findFirst({
      where: { phone: from },
      include: {
        complaints: {
          orderBy: { createdAt: 'desc' }
        }
      }
    });

    let message = '';
    
    if (!citizen || citizen.complaints.length === 0) {
      message = 'No tienes reclamos registrados.';
    } else {
      const complaintsList = citizen.complaints.map(complaint => {
        const statusEmoji = getStatusEmoji(complaint.status as ComplaintStatus);
        return `üî∏ #${complaint.id} - ${complaint.type} ${statusEmoji}
      üìç ${complaint.location}
      üìÖ ${complaint.createdAt.toLocaleDateString()}`;
      }).join('\n\n');

      message = `Tus reclamos:\n\n${complaintsList}\n\nPara ver m√°s detalles de un reclamo espec√≠fico, usa /reclamo <n√∫mero>`;
    }

    await sendWhatsAppMessage(from, message);
    await addMessageToHistory(from, 'assistant', message);

  } catch (error) {
    console.error('Error al obtener reclamos:', error);
    const errorMessage = 'Lo siento, hubo un problema al obtener tus reclamos. Por favor, intenta m√°s tarde.';
    await sendWhatsAppMessage(from, errorMessage);
    await addMessageToHistory(from, 'assistant', errorMessage);
  }
}

async function handleComplaintDetails(from: string, complaintId: number): Promise<void> {
  try {
    const complaint = await prisma.complaint.findFirst({
      where: {
        id: complaintId,
        citizen: {
          phone: from
        }
      },
      include: {
        citizen: true
      }
    });

    let message = '';
    
    if (!complaint) {
      message = 'No se encontr√≥ el reclamo especificado o no tienes permiso para verlo.';
    } else {
      const statusEmoji = getStatusEmoji(complaint.status as ComplaintStatus);
      message = `üìã Detalles del Reclamo #${complaint.id}:
üîπ Tipo: ${complaint.type}
üìù Descripci√≥n: ${complaint.description}
üìç Ubicaci√≥n: ${complaint.location}
üìÖ Fecha: ${complaint.createdAt.toLocaleDateString()}
${statusEmoji} Estado: ${complaint.status}${complaint.status === ComplaintStatus.CANCELADO && complaint.rejectReason ? `
‚ùå Motivo de rechazo: ${complaint.rejectReason}` : ''}

üë§ Datos del Ciudadano:
- Nombre: ${complaint.citizen.name}
- DNI: ${complaint.citizen.documentId}
- Direcci√≥n: ${complaint.citizen.address}`;
    }

    await sendWhatsAppMessage(from, message);
    await addMessageToHistory(from, 'assistant', message);

  } catch (error) {
    console.error('Error al obtener detalles del reclamo:', error);
    const errorMessage = 'Lo siento, hubo un problema al obtener los detalles del reclamo. Por favor, intenta m√°s tarde.';
    await sendWhatsAppMessage(from, errorMessage);
    await addMessageToHistory(from, 'assistant', errorMessage);
  }
}

// Funci√≥n para cambiar el modo de conversaci√≥n
async function handleModeChange(from: string, state: ConversationState, newMode: ConversationMode): Promise<void> {
  // Guardar el modo anterior
  state.previousMode = state.mode;
  
  // Establecer el nuevo modo
  state.mode = newMode;
  
  // Reiniciar la bandera de mensaje de cambio de modo
  state.modeChangeMessageSent = false;
  
  // Mensaje seg√∫n el modo
  let message = '';
  
  switch (newMode) {
    case ConversationMode.INFO:
      message = 'He cambiado al modo de informaci√≥n. Ahora puedes hacerme cualquier consulta sobre servicios, tr√°mites o informaci√≥n municipal y utilizar√© nuestra base de conocimiento para responderte de la manera m√°s completa posible.';
      break;
    case ConversationMode.COMPLAINT:
      message = 'He cambiado al modo de reclamos. Ahora puedes describir tu problema y te guiar√© para registrar un reclamo formal.';
      break;
    case ConversationMode.DEFAULT:
      message = 'He vuelto al modo normal. Puedo ayudarte tanto con consultas de informaci√≥n como con reclamos seg√∫n lo que necesites.';
      break;
  }
  
  // Guardar el estado actualizado
  await setConversationState(from, state);
  
  // Enviar mensaje de confirmaci√≥n
  await sendWhatsAppMessage(from, message);
  await addMessageToHistory(from, 'assistant', message);
}
